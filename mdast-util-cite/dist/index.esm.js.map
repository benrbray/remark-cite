{"version":3,"file":"index.esm.js","sources":["../src/fromMarkdown.ts","../node_modules/mdast-util-to-markdown/lib/util/pattern-compile.js","../node_modules/mdast-util-to-markdown/lib/util/pattern-in-scope.js","../node_modules/mdast-util-to-markdown/lib/util/safe.js","../src/toMarkdown.ts"],"sourcesContent":["import * as Uni from \"unist\";\nimport { Token } from \"micromark/dist/shared-types\";\nimport { MdastExtension } from \"mdast-util-from-markdown/types\";\n\n////////////////////////////////////////////////////////////\n\nexport interface CiteItem {\n\tprefix?: string,\n\tkey: string,\n\tsuffix?: string,\n\tsuppressAuthor?: true|undefined\n}\n\nexport interface InlineCiteNode extends Uni.Literal {\n\ttype: \"cite\",\n\tvalue: string,\n\tdata: {\n\t\taltSyntax?: true|undefined;\n\t\tciteItems: CiteItem[]\n\t}\n}\n\n////////////////////////////////////////////////////////////\n\nexport const citeFromMarkdown: MdastExtension = {\n\tenter : {\n\t\tinlineCite: enterInlineCite,\n\t\tciteItem: enterCiteItem\n\t},\n\texit : {\n\t\tinlineCite: exitInlineCite,\n\t\tinlineCiteMarker_alt: exitInlineCiteMarker_alt,\n\t\tciteItem: exitCiteItem,\n\t\tciteItemPrefix: exitCiteItemPrefix,\n\t\tciteAuthorSuppress: exitCiteAuthorSuppress,\n\t\tciteItemKey: exitCiteItemKey,\n\t\tciteItemSuffix: exitCiteItemSuffix\n\t}\n} as MdastExtension;\n\n////////////////////////////////////////////////////////////\n\nfunction top<T>(stack: T[]) {\n\treturn stack[stack.length - 1]\n}\n\n/**\n * [see @wadler1990; also @hughes1989, pp. 4]\n *\n * inlineCite\n *   inlineCiteMarker [\n *   citeItem\n *     citeItemPrefix \"see \"\n *     citeItemSymbol \"@\"\n *     citeItemKey \"wadler1990\"\n *     citeItemSuffix \"\"\n *   citeItem\n *     citeItemPrefix \" also \"\n *     citeItemSymbol \"@\"\n *     citeItemKey \"hughes1989\"\n *     citeItemSuffix \", pp. 4\"\n *   inlineCiteMarker ]\n */\n\n// -- inlineCite -------------------------------------------\n\nfunction enterInlineCite(this: any, token: unknown) {\n\tthis.enter({\n\t\ttype: 'cite',\n\t\tvalue: null,\n\t\tdata: {\n\t\t\tciteItems: []\n\t\t}\n\t}, token);\n}\n\nfunction exitInlineCite(this: any, token: unknown) {\n\tlet citeNode: InlineCiteNode = this.exit(token);\n\tciteNode.value = this.sliceSerialize(token);\n}\n\n// inlineCiteMarker_alt ------------------------------------\n\n/** Only appears when alternate syntax is used. */\nfunction exitInlineCiteMarker_alt(this: any, token: unknown) {\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\t// @ts-ignore: create invalid citeItem, to be filled later\n\tcurrentNode.data.altSyntax = true;\n}\n\n// -- citeItem ---------------------------------------------\n\nfunction enterCiteItem(this: any, token: Token) {\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\t// @ts-ignore: create invalid citeItem, to be filled later\n\tcurrentNode.data.citeItems.push({ });\n}\n\nfunction exitCiteItem(this: any, token: Token) {\n\t//let item = this.exit(token);\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\tconst currentItem = top(currentNode.data.citeItems);\n\tconst citeSrc = this.sliceSerialize(token);\n}\n\n// -- citeAuthorSuppresss ----------------------------------\n\nfunction exitCiteAuthorSuppress(this: any, token: Token) {\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\tconst currentItem = top(currentNode.data.citeItems);\n\n\tcurrentItem.suppressAuthor = true;\n}\n\n// -- citeItemKey ------------------------------------------\n\nfunction exitCiteItemKey(this: any, token: Token) {\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\tconst currentItem = top(currentNode.data.citeItems);\n\tconst citeKey = this.sliceSerialize(token);\n\n\tcurrentItem.key = citeKey;\n}\n\n// -- citeItemSuffix ---------------------------------------\n\nfunction exitCiteItemSuffix(this: any, token: Token) {\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\tconst currentItem = top(currentNode.data.citeItems);\n\tconst citeSuffix = this.sliceSerialize(token);\n\n\tcurrentItem.suffix = citeSuffix;\n}\n\n// -- citeItemPrefix ---------------------------------------\n\nfunction exitCiteItemPrefix(this: any, token: Token) {\n\tconst currentNode = top(this.stack) as InlineCiteNode;\n\tconst currentItem = top(currentNode.data.citeItems);\n\tconst citePrefix = this.sliceSerialize(token);\n\n\tcurrentItem.prefix = citePrefix;\n}","module.exports = patternCompile\n\nfunction patternCompile(pattern) {\n  var before\n  var after\n\n  if (!pattern._compiled) {\n    before = pattern.before ? '(?:' + pattern.before + ')' : ''\n    after = pattern.after ? '(?:' + pattern.after + ')' : ''\n\n    if (pattern.atBreak) {\n      before = '[\\\\r\\\\n][\\\\t ]*' + before\n    }\n\n    pattern._compiled = new RegExp(\n      (before ? '(' + before + ')' : '') +\n        (/[|\\\\{}()[\\]^$+*?.-]/.test(pattern.character) ? '\\\\' : '') +\n        pattern.character +\n        (after || ''),\n      'g'\n    )\n  }\n\n  return pattern._compiled\n}\n","module.exports = patternInScope\n\nfunction patternInScope(stack, pattern) {\n  return (\n    listInScope(stack, pattern.inConstruct, true) &&\n    !listInScope(stack, pattern.notInConstruct)\n  )\n}\n\nfunction listInScope(stack, list, none) {\n  var index\n\n  if (!list) {\n    return none\n  }\n\n  if (typeof list === 'string') {\n    list = [list]\n  }\n\n  index = -1\n\n  while (++index < list.length) {\n    if (stack.indexOf(list[index]) !== -1) {\n      return true\n    }\n  }\n\n  return false\n}\n","module.exports = safe\n\nvar patternCompile = require('./pattern-compile')\nvar patternInScope = require('./pattern-in-scope')\n\nfunction safe(context, input, config) {\n  var value = (config.before || '') + (input || '') + (config.after || '')\n  var positions = []\n  var result = []\n  var infos = {}\n  var index = -1\n  var before\n  var after\n  var position\n  var pattern\n  var expression\n  var match\n  var start\n  var end\n\n  while (++index < context.unsafe.length) {\n    pattern = context.unsafe[index]\n\n    if (!patternInScope(context.stack, pattern)) {\n      continue\n    }\n\n    expression = patternCompile(pattern)\n\n    while ((match = expression.exec(value))) {\n      before = 'before' in pattern || pattern.atBreak\n      after = 'after' in pattern\n\n      position = match.index + (before ? match[1].length : 0)\n\n      if (positions.indexOf(position) === -1) {\n        positions.push(position)\n        infos[position] = {before: before, after: after}\n      } else {\n        if (infos[position].before && !before) {\n          infos[position].before = false\n        }\n\n        if (infos[position].after && !after) {\n          infos[position].after = false\n        }\n      }\n    }\n  }\n\n  positions.sort(numerical)\n\n  start = config.before ? config.before.length : 0\n  end = value.length - (config.after ? config.after.length : 0)\n  index = -1\n\n  while (++index < positions.length) {\n    position = positions[index]\n\n    if (\n      // Character before or after matched:\n      position < start ||\n      position >= end\n    ) {\n      continue\n    }\n\n    // If this character is supposed to be escaped because it has a condition on\n    // the next character, and the next character is definitly being escaped,\n    // then skip this escape.\n    if (\n      position + 1 < end &&\n      positions[index + 1] === position + 1 &&\n      infos[position].after &&\n      !infos[position + 1].before &&\n      !infos[position + 1].after\n    ) {\n      continue\n    }\n\n    if (start !== position) {\n      // If we have to use a character reference, an ampersand would be more\n      // correct, but as backslashes only care about punctuation, either will\n      // do the trick\n      result.push(escapeBackslashes(value.slice(start, position), '\\\\'))\n    }\n\n    start = position\n\n    if (\n      /[!-/:-@[-`{-~]/.test(value.charAt(position)) &&\n      (!config.encode || config.encode.indexOf(value.charAt(position)) === -1)\n    ) {\n      // Character escape.\n      result.push('\\\\')\n    } else {\n      // Character reference.\n      result.push(\n        '&#x' + value.charCodeAt(position).toString(16).toUpperCase() + ';'\n      )\n      start++\n    }\n  }\n\n  result.push(escapeBackslashes(value.slice(start, end), config.after))\n\n  return result.join('')\n}\n\nfunction numerical(a, b) {\n  return a - b\n}\n\nfunction escapeBackslashes(value, after) {\n  var expression = /\\\\(?=[!-/:-@[-`{-~])/g\n  var positions = []\n  var results = []\n  var index = -1\n  var start = 0\n  var whole = value + after\n  var match\n\n  while ((match = expression.exec(whole))) {\n    positions.push(match.index)\n  }\n\n  while (++index < positions.length) {\n    if (start !== positions[index]) {\n      results.push(value.slice(start, positions[index]))\n    }\n\n    results.push('\\\\')\n    start = positions[index]\n  }\n\n  results.push(value.slice(start))\n\n  return results.join('')\n}\n","// mdast\nimport { Unsafe, Handle, Context } from \"mdast-util-to-markdown\";\nimport safe from 'mdast-util-to-markdown/lib/util/safe.js';\n\n// unist\nimport * as Uni from \"unist\";\n\n// project imports\nimport { InlineCiteNode } from './fromMarkdown';\n\n////////////////////////////////////////////////////////////\n\nexport interface CiteToMarkdownOptions {\n\t/**\n\t * When `true`, nodes with `altSyntax: true` will be rendered in standard\n\t * pandoc syntax `[@cite]` rather than alternative syntax `@[cite]`.  \n\t * \n\t * @default false\n\t */\n\tstandardizeAltSyntax: boolean;\n\t/**\n\t * When `false`, will not suppress authors in the output.\n\t * \n\t * @default true\n\t */\n\tenableAuthorSuppression: boolean;\n\t/**\n\t * `micromark-extension-cite` stores the original Markdown source for each\n\t * citation in the `value` property of each `InlineCiteNode`.  When this\n\t * option is `true`, every citation node serializes to its `value`, rather\n\t * than being reconstructed from `data.citeItems`.\n\t * \n\t * This setting overrides all other options.\n\t * \n\t * @default false\n\t */\n\tuseNodeValue: boolean;\n}\n\n////////////////////////////////////////////////////////////\n\n/**\n * @warning Does no validation.  Garbage in, garbage out.\n */\nexport function citeToMarkdown (options: Partial<CiteToMarkdownOptions> = {}) {\n\t// fill in option defaults\n\tconst settings: CiteToMarkdownOptions = Object.assign({\n\t\tstandardizeAltSyntax: false,\n\t\tenableAuthorSuppression: true,\n\t\tuseNodeValue: false\n\t}, options);\n\t\n\t// TODO:  I don't fully understand what this does, but I did my\n\t// best to fill it in based on what I saw in other mdast utils\n\t// (e.g. https://github.com/syntax-tree/mdast-util-math/blob/main/to-markdown.js)\n\tconst unsafe: Unsafe[] = [\n\t\t{ character: ',', inConstruct: [\"citationKey\"] },\n\t\t{ character: '@', inConstruct: [\"citation\"]    },\n\t]\n\n\t/** Returns an escaped representation of `node.value`. */\n\tfunction handler_useNodeValue(node: InlineCiteNode, _:Uni.Parent|null|undefined, context: Context): string {\n\t\tconst exit = context.enter(\"citation\");\n\t\tconst nodeValue = safe(context, node.value, {});\n\t\texit();\n\t\treturn nodeValue;\n\t}\n\n\t/** Reconstructs the citation using data attached to the `InlineCiteNode`. */\n\tfunction handler_default(node: InlineCiteNode, _:Uni.Parent|null|undefined, context: Context): string {\n\t\t// handle missing items\n\t\tif(node.data.citeItems.length === 0) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\t// decide whether to use alt-syntax or pandoc-syntax\n\t\tconst firstItem = node.data.citeItems[0];\n\t\tconst useAltSyntax: boolean\n\t\t\t=  !settings.standardizeAltSyntax\n\t\t\t&& (node.data.altSyntax === true)\n\t\t\t&& (firstItem.prefix === undefined || firstItem.prefix === \"\") ;\n\n\t\t// escape and reconstruct data\n\t\tconst exit = context.enter('citation');\n\t\tconst safeItems = node.data.citeItems.map((item, idx) => {\n\t\t\tconst exitKey = context.enter(\"citationKey\");\n\t\t\tconst key = safe(context, item.key, { before: \"@\" });\n\t\t\texitKey();\n\n\t\t\t// be careful not to include a prefix for the first tiem when using alternative syntax \n\t\t\tconst prefix = (item.prefix && (!useAltSyntax || idx > 0)) ? safe(context, item.prefix, {}) : \"\";\n\t\t\tconst suffix = item.suffix ? safe(context, item.suffix, {}) : \"\";\n\t\t\tconst suppress = (settings.enableAuthorSuppression && item.suppressAuthor === true) ? \"-\" : \"\";\n\n\t\t\tif(idx === 0) {\n\t\t\t\tif(useAltSyntax) { return `@[${suppress}${key}${suffix}` }\n\t\t\t\telse { return `[${prefix}${suppress}@${key}${suffix}` }\n\t\t\t} else {\n\t\t\t\treturn `;${prefix}${suppress}@${key}${suffix}`\n\t\t\t} \n\t\t});\n\t\texit();\n\t\treturn safeItems.join(\"\") + ']';\n\t};\n\n\tconst handler = settings.useNodeValue ? handler_useNodeValue : handler_default;\n\n\treturn {\n\t\tunsafe: unsafe,\n\t\thandlers: {\n\t\t\t// as of (2021-05-07), the typings for Handle do not reflect\n\t\t\t// that the handler will be passed nodes of a specific type\n\t\t\tcite: handler as unknown as Handle\n\t\t}\n\t}\n}"],"names":["module","patternCompile","pattern","before","after","_compiled","atBreak","RegExp","test","character","patternInScope","stack","listInScope","inConstruct","notInConstruct","list","none","index","length","indexOf","safe","context","input","config","value","positions","result","infos","position","expression","match","start","end","unsafe","exec","push","sort","numerical","escapeBackslashes","slice","charAt","encode","charCodeAt","toString","toUpperCase","join","a","b","results","whole"],"mappings":"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"}